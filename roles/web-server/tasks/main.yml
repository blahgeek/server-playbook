- name: Create directories for hpshare server
  tags:
    - hpshare
    - wedding99
  file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  with_items:
    - /var/hpshare
    - /var/wedding99
    - /var/nginx-proxy/html/wedding99
    - /var/nginx-proxy/html/hpshare

- name: Copy config file for hpshare server
  tags: hpshare
  copy:
    src: hpshare/config.py
    dest: /var/hpshare/config.py

- import_tasks: roles/docker/tasks/virtual-host-nginx-extra.yml
  tags: hpshare
  vars:
    host: "{{ hpshare.domain }}"
    static_url_path: "/~static/"
    static_dir: "hpshare"

- name: Configure docker hpshare
  docker_container:
    container_default_behavior: no_defaults
    restart_policy: unless-stopped
    name: hpshare
    image: blahgeek/hpurl:0.4.1
    volumes:
      - /var/hpshare:/data
      - /var/nginx-proxy/html/hpshare:/static
    env:
      DJANGO_SECRET_KEY: "{{ hpshare.django_secret_key }}"
      DJANGO_ALLOWED_HOST: "{{ hpshare.domain }}"
      DJANGO_STATIC_ROOT: "/static"
      ADMIN_USER: "{{ hpshare.admin_user }}"
      ADMIN_EMAIL: "{{ hpshare.admin_email }}"
      ADMIN_PASSWD: "{{ hpshare.admin_password }}"
      VIRTUAL_PORT: "8000"
      VIRTUAL_PROTO: "uwsgi"
      VIRTUAL_HOST: "{{ hpshare.domain }}"
      LETSENCRYPT_HOST: "{{ hpshare.domain }}"
    expose: 8000
  tags: hpshare

- name: Configure docker blog website
  docker_container:
    container_default_behavior: no_defaults
    restart_policy: unless-stopped
    name: blog
    image: blahgeek/blog:20220603-2225
    env:
      VIRTUAL_PORT: "80"
      VIRTUAL_HOST: "blog.blahgeek.com,z1k.dev"
      LETSENCRYPT_HOST: "blog.blahgeek.com,z1k.dev"
    expose: 80

- name: Copy config file for wedding99 server
  tags: wedding99
  copy:
    src: wedding99/config.py
    dest: /var/wedding99/config.py

- import_tasks: roles/docker/tasks/virtual-host-nginx-extra.yml
  tags: wedding99
  vars:
    host: "{{ wedding99.domain }}"
    static_url_path: "/static"
    static_dir: "wedding99"

- name: Configure docker wedding99
  docker_container:
    container_default_behavior: no_defaults
    restart_policy: unless-stopped
    name: wedding99
    image: blahgeek/wedding99:0.0.5
    volumes:
      - /var/wedding99:/data
      - /var/nginx-proxy/html/wedding99:/static
    env:
      ADMIN_USER: "{{ wedding99.admin_user }}"
      ADMIN_EMAIL: "{{ wedding99.admin_email }}"
      ADMIN_PASSWD: "{{ wedding99.admin_password }}"
      DJANGO_STATIC_ROOT: "/static"
      VIRTUAL_PORT: "8000"
      VIRTUAL_HOST: "{{ wedding99.domain }}"
      VIRTUAL_PROTO: "uwsgi"
      LETSENCRYPT_HOST: "{{ wedding99.domain }}"
    expose: 8000
  tags: wedding99
